## 目标与范围
- 单机优先：录音、文本与图片全部在手机本地完成采集与存储；不依赖后端。
- 会话化：一次会议=一个会话文件夹，包含音频、文本（笔记）、图片等。
- 本地转录：集成 whisper.cpp（Whisper Large v3 Q5），离线完成转录。
- 在线总结：联网时把“录音转录文本”发到 DeepSeek 获取“总结”，写回本地数据库。
- 历史与搜索：本地数据库记录按时间倒序展示，支持全文检索。

## 存储布局（公共目录）
- 根路径：`Download/airecording/`
- 会话文件夹：`Download/airecording/<session_id>/`
  - 命名：`<YYYYMMDDHHmmss>`，可附加城市或标题前缀：`<YYYYMMDDHHmmss>-<city-or-short-title>`
  - 文件：
    - 录音：`audio.m4a`（或按段：`audio-1.m4a`、`audio-2.m4a`）
    - 笔记：`note.txt`（用户编辑内容，包含时间/地点/人员/hashtags/笔记正文）
    - 图片：`img-<n>.jpg`
- 写入方式：`MediaStore.Downloads` 使用 `RELATIVE_PATH = "Download/airecording/<session_id>/"`
- 兼容：老数据仍保留在 `Download/airecording/`，提供一次性“导入旧数据为会话”的扫描工具

## 本地数据库（Room + SQLite/FTS5）
- 表 `sessions`
  - `id` INTEGER PK AUTOINCREMENT
  - `session_id` TEXT UNIQUE NOT NULL（文件夹名）
  - `time` TEXT ISO8601（来自 note 第一行）
  - `location` TEXT
  - `people` TEXT[] / JSON 序列化到 TEXT（Room 使用 `@TypeConverter`）
  - `hashtags` TEXT[] / JSON 序列化到 TEXT
  - `note` TEXT（“笔记：”后的原文，原样）
  - `transcript` TEXT（本地 Whisper 结果）
  - `summary` TEXT（DeepSeek 分析结果）
  - `audio_uri` TEXT（主音频 Uri）
  - `created_at` TEXT ISO8601，`updated_at` TEXT ISO8601
  - 状态字段：
    - `file_state` ENUM("saving","saved")
    - `audio_state` ENUM("none","transcribing","done")
    - `summary_state` ENUM("none","waiting_network","done")
- 表 `images`
  - `id` INTEGER PK AUTOINCREMENT
  - `session_id` TEXT（FK -> sessions.session_id）
  - `image_uri` TEXT
  - `created_at` TEXT ISO8601
- FTS `sessions_fts`（可选）
  - 针对 `note`、`transcript`、`summary`、`hashtags`、`people` 建 FTS5 虚表
  - 写入/更新时同步一份到 `sessions_fts`

## 状态机与流程
- 文件状态 `file_state`
  - 保存文件到 `MediaStore` 成功 → `saved`
- 音频状态 `audio_state`
  - 无音频 → `none`
  - 触发本地转录 → `transcribing`
  - Whisper 完成并写库 → `done`
- 总结状态 `summary_state`
  - 无音频 → `none`
  - 有 `transcript` 且无网或暂不发送 → `waiting_network`
  - DeepSeek 完成并写库 → `done`
- 统一由 WorkManager 驱动：
  - `TranscribeWorker`（需前台任务+WakeLock）
  - `SummarizeWorker`（需要联网约束，失败指数退避）
  - 监听网络变化，进入联机时自动调度 `SummarizeWorker`

## Whisper.cpp 集成（Android）
- 模型：Whisper Large v3 Q5 量化模型（>1GB），应用启动首次下载到 `context.filesDir/models/`；SHA256 校验；支持断点续传。
- JNI 封装：
  - 引入 `whisper.cpp` 源码，通过 NDK 构建 `.so`（`arm64-v8a` 为主）
  - 提供 `nativeTranscribe(filePath, modelPath, lang, diarization?, timestamps?)` 接口
  - Streaming/Chunk 方案：边读 m4a 边转码 PCM（`MediaExtractor`+`MediaCodec`）后送给 whisper
- 前台服务：
  - `ForegroundService` + 通知，展示“转录中…进度”
  - 获取 `PARTIAL_WAKE_LOCK` 保持 CPU 不中断
- 性能与降级：
  - 优先使用 `Large v3 Q5`；若设备内存/性能不足，允许在设置中切换 `medium/base` 量化模型

## DeepSeek 总结（联网时）
- 触发条件：`transcript` 可用且 `summary_state != done`；网络可用
- 调用：`/v1/chat/completions`（可配置 baseUrl、model），带用户可编辑的 prompt（后续你提供）
- 仅发送 `transcript` 与结构化元数据（时间/地点/人员/hashtags）；不上传 `note`
- 成功后更新 `summary` 并将 `summary_state` 置为 `done`

## 解析 note.txt 规则（与后端一致）
- 第一行：时间 → 解析成 ISO8601
- 第二行：地点
- 行内解析：
  - `人员：张三、李四` → `people = ["张三","李四"]`
  - `#标签` 收集为 `hashtags = ["#会议",...]`
- `笔记：` 之后为正文 `note`，原样入库

## 页面与交互
- 主页（会话采集）
  - 文本输入区（实时写入 note.txt）
  - 录音：开始/结束按钮（保存到会话文件夹）
  - 拍照/选图：保存到会话文件夹并写 `images` 表
  - 顶部状态条：展示三段状态（文件/音频/总结）
- 历史记录
  - 按 `time` 倒序
  - 列表项展示：标题（note 第一行或 summary 的标题）、时间、地点、人员、hashtags、缩略图
  - 详情页：音频播放器、图片画廊、笔记全文、转录、总结
  - 搜索：支持全文搜索（FTS5）与标签/人员筛选
- 设置页（可选）
  - 模型管理（下载/校验/切换）
  - 性能与电量（是否允许大模型、是否仅充电时转录）
  - DeepSeek API Key 配置

## 权限与系统要求
- 权限：`RECORD_AUDIO`、`CAMERA`、`READ_MEDIA_*`（Android 13+ 分类权限）、`INTERNET`
- 电池优化：引导用户为应用关闭电池优化，确保后台不被杀
- 前台服务通知权限（Android 13+）

## 迁移与兼容
- 从现有平铺文件迁移到会话结构：
  - 扫描 `Download/airecording/*.m4a|.txt|.jpg`
  - 以同名基名分组创建 `<session_id>` 文件夹并移动文件
  - 解析 `.txt` 入库，补齐 `audio_uri`/`images`
- 旧后端：不再依赖；若需要云备份可做增量方案（后续阶段）

## 里程碑
- 阶段 1：会话文件夹与 Room 架构
  - 新建 `sessions`/`images` 表与 DAO/Repository
  - 会话创建、音频/笔记/图片保存统一落到子文件夹
  - 列表与详情页雏形
- 阶段 2：Whisper.cpp 本地转录
  - 集成 NDK + JNI，模型下载与校验
  - `TranscribeWorker` + ForegroundService
  - 音频状态联动
- 阶段 3：DeepSeek 总结
  - `SummarizeWorker`（联网约束）
  - Prompt 配置化，状态联动
- 阶段 4：历史与搜索增强
  - FTS5 全文检索、筛选
  - 图片缩略图与播放体验优化
- 阶段 5：导入旧数据与稳定性
  - 旧数据扫描与迁移
  - 低电量/低内存降级策略

## 关键技术点
- Room + TypeConverter(JSON 字段) + FTS5
- MediaStore 多类型统一相对子目录写入
- Whisper.cpp NDK 编译与 JNI 封装、PCM 解码管线
- WorkManager 前台任务 + WakeLock
- 网络监听与任务编排

## 交付物
- 数据库实体/DAO/迁移脚本
- Whisper JNI 封装与模型管理模块
- 两个 Worker（转录/总结）与前台服务
- 会话化文件存储工具与旧数据迁移脚本
- 历史/搜索 UI 与主流程打通

请确认此方案是否符合你的预期：
- 会话文件夹命名是否采用纯时间（推荐）还是时间+短标题？
- 模型体积较大（>1GB），是否接受首次下载并提供“仅 Wi-Fi”与“仅充电时下载”的限制？
- 搜索是否需要对 `people/hashtags` 做单独筛选面板？